cmake_minimum_required(VERSION 3.30)

project(occt-wasm)
# 设置C++标准为17
set(CMAKE_CXX_STANDARD 17)

set(TARGET occt-wasm)
# 设置构建类型为Debug和Release
set(CMAKE_CONFIGURATION_TYPES Debug;Release)

set(CMAKE_NINJA_FORCE_RESPONSE_FILE 1 CACHE INTERNAL "")

# 设置构建产物输出目录
set(CMAKE_INSTALL_PREFIX "${CMAKE_SOURCE_DIR}/build")

set(OCCT_SOURCE_DIR "${CMAKE_SOURCE_DIR}/source/occt")


set(OCCT_MODULES
    # 必须的基础
    TKernel TKMath
    # 几何与拓扑
    TKG2d TKG3d TKGeomBase TKBRep
    # 建模（按需）
    TKPrim          # 创建基本体
    TKBool          # 布尔运算（如果需要）
    TKMesh          # 生成三角网格（用于 WebGL 渲染）
    # 数据交换（按需）
    TKDESTEP        # 读写 STEP
    TKDESTL         # 读写 STL
)

set(OCCT_USED_PACKAGES)
foreach(MODULE IN LISTS OCCT_MODULES)
    set(PACKAGES_FILE "${OCCT_SOURCE_DIR}/src/${MODULE}/PACKAGES")
    if(NOT EXISTS "${PACKAGES_FILE}")
        message(FATAL_ERROR "PACKAGES file not found: ${PACKAGES_FILE}")
    endif()
    file(STRINGS "${PACKAGES_FILE}" PKGS)
    list(APPEND OCCT_USED_PACKAGES ${PKGS})
endforeach()
list(REMOVE_DUPLICATES OCCT_USED_PACKAGES)

set(OCCT_INCLUDE_DIRS "")
foreach(pkg IN LISTS OCCT_USED_PACKAGES)
    list(APPEND OCCT_INCLUDE_DIRS
        "${OCCT_SOURCE_DIR}/src/${pkg}"
    )
endforeach()

list(APPEND OCCT_INCLUDE_DIRS
    "${CMAKE_CURRENT_BINARY_DIR}/include"
    "${CMAKE_CURRENT_SOURCE_DIR}/src"
)

include_directories(${OCCT_INCLUDE_DIRS})

# 配置Standard_Version.hxx文件
include("${OCCT_SOURCE_DIR}/adm/cmake/version.cmake")
configure_file(
    "${OCCT_SOURCE_DIR}/adm/templates/Standard_Version.hxx.in"
    "${CMAKE_CURRENT_BINARY_DIR}/include/Standard_Version.hxx"
    @ONLY
)
list(APPEND OCCT_INCLUDE_DIRS "${CMAKE_CURRENT_BINARY_DIR}/include")
# 添加OCCT源码目录到包含路径（OCCT头文件在src目录下）
list(APPEND OCCT_INCLUDE_DIRS "${OCCT_SOURCE_DIR}/src")

# 收集src下的代码文件
set(MY_SOURCES "")
if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/src")
    file(GLOB MY_SOURCES CONFIGURE_DEPENDS
        "${CMAKE_CURRENT_SOURCE_DIR}/src/*.cpp"
        "${CMAKE_CURRENT_SOURCE_DIR}/src/*.cxx"
    )
endif()

# 添加包含目录
include_directories(
    ${OCCT_INCLUDE_DIRS}
    "${CMAKE_CURRENT_SOURCE_DIR}/src"
)

# 创建可执行文件或库
if(EMSCRIPTEN)
    add_executable(${TARGET} ${OCCT_SOURCES} ${MY_SOURCES})

    target_compile_options(${TARGET} PUBLIC
        --bind
    )

    target_link_options(${TARGET} PUBLIC
        --bind
        -sMODULARIZE=1
        -sEXPORT_ES6=1
        -sEXPORT_NAME=createOcctWasmModule
        -sENVIRONMENT=web

        -sALLOW_MEMORY_GROWTH=1
        -sINITIAL_HEAP=128MB
        -sMAXIMUM_MEMORY=4GB

        $<$<CONFIG:Release>:-O3>
        $<$<CONFIG:Release>:-flto>
        $<$<CONFIG:Debug>:-O0>
        $<$<CONFIG:Debug>:-g>

        --emit-tsd "${TARGET}.d.ts"
    )
endif()